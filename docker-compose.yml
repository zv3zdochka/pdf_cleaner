services:
  bot:
    build: .
    container_name: pdf-cleaner-bot
    restart: always
    environment:
      BOT_TOKEN: ${BOT_TOKEN}
      MODEL_PATH: /app/weights.onnx

      # единое хранилище для бота и вебки
      STORAGE_DIR: /app/storage

      # 30 GiB лимит (без авто-удалений, см. правки к боту ниже)
      STORAGE_MAX_BYTES: 32212254720
      STORAGE_MAX_AGE_DAYS: 0

      LOGS_DIR: /app/logs
      LOG_LEVEL: INFO
    volumes:
      - /opt/pdf_bot_storage:/app/storage
      - /opt/pdf_bot_logs:/app/logs
    mem_limit: 5g
    memswap_limit: 5g

  web:
    build: ./web
    container_name: pdf-cleaner-web
    restart: always
    environment:
      STORAGE_DIR: /app/storage
      STORAGE_MAX_BYTES: 32212254720

      # опционально: защита вебки токеном
      WEB_TOKEN: ${WEB_TOKEN:-}
      WEB_PORT: 8000
    volumes:
      - /opt/pdf_bot_storage:/app/storage
    ports:
      - "8081:8000"
    depends_on:
      - bot
